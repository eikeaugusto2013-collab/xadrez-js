<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Xadrez IA Avançada</title>

<style>
body{
  background:#222;color:#fff;font-family:Arial;
  display:flex;flex-direction:column;align-items:center;
  justify-content:center;min-height:100vh
}
.board{
  display:grid;
  grid-template-columns:repeat(8,64px);
  grid-template-rows:repeat(8,64px);
  border:4px solid #000
}
.cell{
  width:64px;height:64px;
  display:flex;align-items:center;justify-content:center;
  position:relative;cursor:pointer
}
.white{background:#f0d9b5}
.black{background:#b58863}
.cell img{width:52px;height:52px;pointer-events:none}
.selected{outline:3px solid red}
.hint::after{
  content:"";width:16px;height:16px;border-radius:50%;
  background:rgba(0,0,0,.35);position:absolute
}
.msg{margin:8px;font-size:18px}
button{margin-top:8px;padding:6px 14px}
</style>
</head>

<body>
<div class="msg" id="msg"></div>
<div class="board" id="board"></div>
<button onclick="resetGame()">Reiniciar</button>

<script>
/* ================= CONFIG ================= */
const images={
 p:"peao1.png", r:"torre1.png", n:"cavalo1.png",
 b:"bispo1.png", q:"rainha1.png", k:"rei1.png",
 P:"peao2.png", R:"torre2.png", N:"cavalo2.png",
 B:"bispo2.png", Q:"rainha2.png", K:"rei2.png"
};

const initial=[
"rnbqkbnr","pppppppp","........","........",
"........","........","PPPPPPPP","RNBQKBNR"
].map(r=>r.split(""));

let board,turn,selected,lastMove,gameOver;
const boardEl=document.getElementById("board");
const msgEl=document.getElementById("msg");
const isWhite=p=>p>="A"&&p<="Z";

/* ================= INIT ================= */
function resetGame(){
 board=initial.map(r=>r.slice());
 turn="white";selected=null;lastMove=null;gameOver=false;
 msgEl.textContent="";draw();
}

/* ================= DRAW ================= */
function draw(){
 boardEl.innerHTML="";
 for(let r=0;r<8;r++)for(let c=0;c<8;c++){
  const cell=document.createElement("div");
  cell.className="cell "+((r+c)%2?"black":"white");
  cell.dataset.r=r;cell.dataset.c=c;
  const p=board[r][c];
  if(p!="."){
   const img=document.createElement("img");
   img.src=images[p];cell.appendChild(img);
  }
  cell.onclick=()=>clickCell(cell);
  boardEl.appendChild(cell);
 }
}

/* ================= CLICK ================= */
function clickCell(cell){
 if(gameOver||turn!=="white")return;
 const r=+cell.dataset.r,c=+cell.dataset.c;
 const p=board[r][c];

 if(selected){
  const {r:fr,c:fc}=selected;
  if(isValidMove(board,board[fr][fc],fr,fc,r,c)){
   makeMove(board,fr,fc,r,c,true);
   clearSelection();postMove();return;
  }
  clearSelection();
 }
 if(p!="."&&isWhite(p)){
  selected={r,c};
  cell.classList.add("selected");
  showHints(r,c,p);
 }
}

function clearSelection(){
 document.querySelectorAll(".cell").forEach(c=>c.classList.remove("selected","hint"));
 selected=null;
}

function showHints(r,c,p){
 for(let tr=0;tr<8;tr++)
  for(let tc=0;tc<8;tc++)
   if(isValidMove(board,p,r,c,tr,tc))
    boardEl.children[tr*8+tc].classList.add("hint");
}

/* ================= MOVES ================= */
function makeMove(b,fr,fc,tr,tc,real=false){
 const p=b[fr][fc];b[fr][fc]=".";b[tr][tc]=p;

 // promoção
 if(p==="P"&&tr===0&&real) b[tr][tc]=choosePromotion(true);
 if(p==="p"&&tr===7&&real) b[tr][tc]=choosePromotion(false);

 lastMove={p,fr,fc,tr,tc};
}

function choosePromotion(isW){
 let c=prompt("Promoção: Q, R, B ou N","Q").toUpperCase();
 if(!["Q","R","B","N"].includes(c))c="Q";
 return isW?c:c.toLowerCase();
}

function postMove(){
 checkMate();
 if(!gameOver){turn="black";setTimeout(aiMove,200);}
 draw();
}

/* ================= AI MINIMAX ================= */
function aiMove(){
 let best=-999999,move=null;
 forEachMove(board,false,(nb,m)=>{
  const score=minimax(nb,4,true,-1e9,1e9);
  if(score>best){best=score;move=m;}
 });
 if(!move){msgEl.textContent="Xeque-mate! Brancas vencem.";gameOver=true;return;}
 makeMove(board,move.fr,move.fc,move.tr,move.tc,true);
 turn="white";checkMate();draw();
}

function minimax(b,d,max,a,beta){
 if(d===0)return evaluate(b);
 let best=max?-1e9:1e9;
 forEachMove(b,max,(nb)=>{
  const v=minimax(nb,d-1,!max,a,beta);
  best=max?Math.max(best,v):Math.min(best,v);
  max?(a=Math.max(a,best)):(beta=Math.min(beta,best));
  if(beta<=a)return best;
 });
 return best;
}

function forEachMove(b,isW,cb){
 for(let r=0;r<8;r++)for(let c=0;c<8;c++){
  const p=b[r][c];
  if(p!="."&&isWhite(p)==isW)
   for(let tr=0;tr<8;tr++)for(let tc=0;tc<8;tc++)
    if(isValidMove(b,p,r,c,tr,tc)){
     const nb=b.map(r=>r.slice());
     makeMove(nb,r,c,tr,tc);
     cb(nb,{fr:r,fc:c,tr,tc});
    }
 }
}

/* ================= EVAL ================= */
const pieceVal={p:100,n:320,b:330,r:500,q:900,k:0};
function evaluate(b){
 let s=0;
 for(let r=0;r<8;r++)for(let c=0;c<8;c++){
  const p=b[r][c];
  if(p!=".") s+=(isWhite(p)?-1:1)*pieceVal[p.toLowerCase()];
 }
 return s;
}

/* ================= RULES ================= */
function isValidMove(b,p,fr,fc,tr,tc){
 if(fr===tr&&fc===tc)return false;
 const t=b[tr][tc];
 if(t!="."&&isWhite(t)==isWhite(p))return false;
 const dr=tr-fr,dc=tc-fc;
 switch(p.toLowerCase()){
  case"p":{
   const d=isWhite(p)?-1:1;
   if(dc===0&&t==="."&&dr===d)return true;
   if(Math.abs(dc)===1&&dr===d&&t!=".")return true;
   return false;
  }
  case"r":return dr===0||dc===0;
  case"b":return Math.abs(dr)===Math.abs(dc);
  case"q":return dr===0||dc===0||Math.abs(dr)===Math.abs(dc);
  case"n":return (Math.abs(dr)==2&&Math.abs(dc)==1)||(Math.abs(dr)==1&&Math.abs(dc)==2);
  case"k":return Math.abs(dr)<=1&&Math.abs(dc)<=1;
 }
 return false;
}

/* ================= CHECK ================= */
function checkMate(){
 let w=false,bk=false;
 for(let r=0;r<8;r++)for(let c=0;c<8;c++){
  if(board[r][c]==="K")w=true;
  if(board[r][c]==="k")bk=true;
 }
 if(!bk){msgEl.textContent="Xeque-mate! Brancas vencem.";gameOver=true;}
 if(!w){msgEl.textContent="Xeque-mate! Pretas vencem.";gameOver=true;}
}

/* ================= START ================= */
resetGame();
</script>
</body>
</html>
